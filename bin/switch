#!/usr/bin/env zsh

error() {
    revolver stop &> /dev/null
    echo "Error occured while switching connection!"
    exit 1
}

trap error ERR

# Get sudo privileges immediatly
sudo echo > /dev/null

# Get local IP and interface
my_ip=$(ip route get 8.8.8.8 | awk '/8.8.8.8/ {print $NF}')
my_interface=$(ip route get 8.8.8.8 | awk '/dev/ {f=NR} f&&NR-1==f' RS=" ")

adsl() {
    revolver start "Switching connection to ADSL"
    sudo ip addr del 192.168.2.27/24 dev "$my_interface" > /dev/null 2>&1 || true
    sudo ip addr add 192.168.2.28/24 broadcast 192.168.2.255 dev "$my_interface"
    sudo ip route add default via 192.168.2.3
    sleep 1
    revolver stop
}

lte() {
    revolver start "Switching connection to LTE"
    sudo ip addr del 192.168.2.28/24 dev "$my_interface" > /dev/null 2>&1 || true
    sudo ip addr add 192.168.2.27/24 broadcast 192.168.2.255 dev "$my_interface"
    sudo ip route add default via 192.168.2.3
    sleep 1
    revolver stop
}

if [ "$1" = "adsl" ]; then
    adsl
elif [ "$1" = "lte" ]; then
    lte
elif [ "$1" = "" ]; then
    if [ "$my_ip" = "192.168.2.28" ]; then
        lte
    elif [ "$my_ip" = "192.168.2.27" ]; then
        adsl
    else
        echo "Unable to detect current connection! Defaulting to ADSL."
        adsl
    fi
else
    echo "Unknown option: $1"
    echo "Available options: adsl, lte or none (will switch between adsl and lte)"
fi
